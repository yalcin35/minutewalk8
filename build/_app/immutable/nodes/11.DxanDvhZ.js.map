{"version":3,"file":"11.DxanDvhZ.js","sources":["../../../../../../src/routes/audit/setup/+page.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import { goto } from '$app/navigation';\n  import { fade, fly } from 'svelte/transition';\n  import { _ } from 'svelte-i18n';\n  import { Orbit, Building2, Map, Users, ClipboardCheck, ArrowRight, ArrowLeft } from 'lucide-svelte';\n  import { supabase } from '$lib/supabase';\n  import { onMount } from 'svelte';\n  import { user, isLoading, clearSupabaseAuth } from '$lib/supabase';\n\n  let loading = true;\n  let error: string | null = null;\n  let saving = false;\n\n  // Form data\n  let selectedSite = '';\n  let selectedDepartment = '';\n  let selectedAuditType = '';\n\n  // Options\n  let sites: Array<{ id: string; name: string }> = [];\n  let departments: Array<{ id: string; name: string; site_id: string }> = [];\n  let userLevel = 5; // Default to lowest level\n\n  const auditTypes = [\n    { value: '5s', labelKey: 'walks.5s' },\n    { value: 'hse', labelKey: 'walks.hse' },\n    { value: 'mhe', labelKey: 'walks.mhe' },\n    { value: 'gemba', labelKey: 'walks.gemba' }\n  ];\n\n  onMount(async () => {\n    // Check if user is authenticated\n    if (!$user && !$isLoading) {\n      clearSupabaseAuth();\n      goto('/signin');\n      return;\n    }\n\n    try {\n      // Fetch sites for the user's company\n      const { data: userData } = await supabase.auth.getUser();\n      if (!userData.user) throw new Error('Not authenticated');\n\n      // Get user's level\n      const { data: levelData } = await supabase\n        .from('user_levels')\n        .select('level')\n        .eq('user_id', userData.user.id)\n        .single();\n\n      if (levelData) {\n        userLevel = levelData.level;\n      }\n\n      const { data: profile } = await supabase\n        .from('profiles')\n        .select('company_id')\n        .eq('id', userData.user.id)\n        .single();\n\n      if (!profile?.company_id) throw new Error('Company not found');\n\n      // Fetch sites\n      const { data: sitesData, error: sitesError } = await supabase\n        .from('sites')\n        .select('*')\n        .eq('company_id', profile.company_id);\n\n      if (sitesError) throw sitesError;\n      sites = sitesData;\n\n      // Fetch departments\n      const { data: departmentsData, error: departmentsError } = await supabase\n        .from('departments')\n        .select('*')\n        .eq('company_id', profile.company_id);\n\n      if (departmentsError) throw departmentsError;\n      departments = departmentsData;\n\n    } catch (e) {\n      console.error('Error loading data:', e);\n      error = e instanceof Error ? e.message : 'Failed to load data';\n    } finally {\n      loading = false;\n    }\n  });\n\n  // Filter departments based on selected site\n  $: filteredDepartments = departments.filter(\n    dept => dept.site_id === selectedSite\n  );\n\n  async function handleSubmit() {\n    if (!selectedSite || !selectedDepartment || !selectedAuditType) {\n      error = 'Please fill in all fields';\n      return;\n    }\n\n    saving = true;\n    error = null;\n\n    try {\n      const { data: { user } } = await supabase.auth.getUser();\n      if (!user) throw new Error('Not authenticated');\n\n      // Create audit setup record with start time\n      const { error: setupError } = await supabase\n        .from('audit_setups')\n        .insert({\n          user_id: user.id,\n          site_id: selectedSite,\n          department_id: selectedDepartment,\n          audit_type: selectedAuditType,\n          start_time: new Date().toISOString() // Record the start time\n        });\n\n      if (setupError) throw setupError;\n\n      // Redirect to the appropriate audit questions page based on type\n      if (selectedAuditType === 'hse') {\n        goto('/audit/hse-questions');\n      } else if (selectedAuditType === 'mhe') {\n        goto('/audit/mhe-questions');\n      } else if (selectedAuditType === 'gemba') {\n        goto('/audit/gemba-questions');\n      } else {\n        goto('/audit/questions');\n      }\n    } catch (e) {\n      console.error('Error saving audit setup:', e);\n      error = e instanceof Error ? e.message : 'Failed to save audit setup';\n    } finally {\n      saving = false;\n    }\n  }\n\n  function handleBack() {\n    goto('/dashboard');\n  }\n</script>\n\n<div class=\"min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 py-12 px-6\">\n  <div class=\"max-w-2xl mx-auto space-y-8\">\n    <!-- Header with Back Button -->\n    <div class=\"flex items-center justify-between\">\n      <div class=\"flex items-center space-x-3\">\n        <div class=\"brand-logo\">\n          <Orbit class=\"w-6 h-6\" />\n        </div>\n        <div>\n          <h1 class=\"text-2xl font-light text-gray-900\">{$_('nav.newWalk')}</h1>\n          <p class=\"text-gray-500\">{$_('walks.configureWalk')}</p>\n        </div>\n      </div>\n      <button\n        on:click={handleBack}\n        class=\"flex items-center space-x-2 px-4 py-2 text-sm text-gray-600 \n               bg-white/70 rounded-lg hover:bg-white/90 transition-colors\n               focus:outline-none focus:ring-2 focus:ring-blue-500\"\n      >\n        <ArrowLeft class=\"w-4 h-4\" />\n        <span>{$_('settings.backToDashboard')}</span>\n      </button>\n    </div>\n\n    {#if loading}\n      <div class=\"flex justify-center py-12\">\n        <div class=\"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500\"></div>\n      </div>\n    {:else}\n      <div class=\"bg-white/70 backdrop-blur-sm shadow-lg rounded-2xl p-6 space-y-6\">\n        <form class=\"space-y-6\" on:submit|preventDefault={handleSubmit}>\n          <!-- Site Selection -->\n          <div class=\"space-y-2\">\n            <label class=\"flex items-center space-x-2 text-sm font-medium text-gray-700\">\n              <Map class=\"w-4 h-4\" />\n              <span>{$_('checkin.site')}</span>\n            </label>\n            <select\n              bind:value={selectedSite}\n              class=\"w-full px-4 py-2 rounded-xl bg-white/50 border-gray-200\n                     focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n            >\n              <option value=\"\">{$_('walks.selectSite')}</option>\n              {#each sites as site}\n                <option value={site.id}>{site.name}</option>\n              {/each}\n            </select>\n          </div>\n\n          <!-- Department Selection -->\n          <div class=\"space-y-2\">\n            <label class=\"flex items-center space-x-2 text-sm font-medium text-gray-700\">\n              <Building2 class=\"w-4 h-4\" />\n              <span>{$_('checkin.department')}</span>\n            </label>\n            <select\n              bind:value={selectedDepartment}\n              disabled={!selectedSite}\n              class=\"w-full px-4 py-2 rounded-xl bg-white/50 border-gray-200\n                     focus:ring-2 focus:ring-blue-500 focus:border-blue-500\n                     disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              <option value=\"\">{$_('walks.selectDepartment')}</option>\n              {#each filteredDepartments as department}\n                <option value={department.id}>{department.name}</option>\n              {/each}\n            </select>\n          </div>\n\n          <!-- Audit Type Selection -->\n          <div class=\"space-y-2\">\n            <label class=\"flex items-center space-x-2 text-sm font-medium text-gray-700\">\n              <ClipboardCheck class=\"w-4 h-4\" />\n              <span>{$_('walks.selectWalkType')}</span> </label>\n            <select\n              bind:value={selectedAuditType}\n              class=\"w-full px-4 py-2 rounded-xl bg-white/50 border-gray-200\n                     focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n            >\n              <option value=\"\">{$_('walks.selectWalkType')}</option>\n              {#each auditTypes as type}\n                <option value={type.value}>\n                  {$_(type.labelKey)}\n                </option>\n              {/each}\n            </select>\n          </div>\n\n          {#if error}\n            <div \n              class=\"bg-red-50 text-red-600 p-4 rounded-lg\"\n              transition:fly={{ y: 10, duration: 300 }}\n            >\n              {error}\n            </div>\n          {/if}\n\n          <!-- Submit Button -->\n          <button\n            type=\"submit\"\n            class=\"w-full flex items-center justify-center space-x-2 py-3 px-4\n                   bg-blue-500 text-white rounded-xl hover:bg-blue-600 \n                   focus:outline-none focus:ring-2 focus:ring-blue-500 \n                   focus:ring-offset-2 transition-colors disabled:opacity-50 \n                   disabled:cursor-not-allowed\"\n            disabled={saving}\n          >\n            {#if saving}\n              <div class=\"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\n              <span>Setting up...</span>\n            {:else}\n              <span>{$_('walks.startWalk')}</span>\n              <ArrowRight class=\"w-5 h-5\" />\n            {/if}\n          </button>\n        </form>\n      </div>\n    {/if}\n  </div>\n</div>"],"names":["$.mutable_source","$.get","user","$.set","$.each","$.set_text","$.transition","$.template_effect","$.derived_safe_equal","$.bind_select_value"],"mappings":"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"}